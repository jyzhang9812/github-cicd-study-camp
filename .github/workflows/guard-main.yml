name: Guard Main (docs-only)

on:
  pull_request:
    branches: [ main ]

jobs:
  check-paths:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: List and validate changed paths
        run: |
          set -e
          base_sha="${{ github.event.pull_request.base.sha }}"
          head_sha="${{ github.event.pull_request.head.sha }}"

          echo "Diff: $base_sha..$head_sha"
          CHANGED_FILES=$(git diff --name-only "$base_sha" "$head_sha" || true)

          echo "Changed files (raw):"
          printf '%s\n' "$CHANGED_FILES"

          # 允许 main 的路径：
          # - docs/**   → 各回のメモ
          # - .github/**→ ワークフロー・テンプレート
          # - README.md → ルートのREADME（不要ならこの行を消してOK）
          ALLOW_REGEX='^(docs/|\.github/|README\.md$)'

          BAD_FILES=$(printf '%s\n' "$CHANGED_FILES" | grep -vE "$ALLOW_REGEX" || true)

          if [ -n "$BAD_FILES" ]; then
            echo "❌ 非許可パスの変更があります（mainには入れません）:"
            printf '%s\n' "$BAD_FILES"
            echo
            echo "✅ main に入れて良いのは docs/**, .github/**, README.md のみです。"
            exit 1
          fi

          echo "✅ docs/.github/README.md のみの変更です（OK）"
